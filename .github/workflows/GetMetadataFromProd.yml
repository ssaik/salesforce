# Unique name for this workflow
name: Validate PR on integration branch

# Definition when the workflow should run
on:
    pull_request:
      # This workflow will run when a pull request is opened, or when a commit is pushed
      # to a branch that has an existing pull request
      types: [opened, synchronize]
      branches: [ dev ]
      # We only care about changes to the force-app directory. This prevents the job from running
      # when changing non-salesforce files (like this yml file).
      paths:
        - 'force-app/**'
            

# Jobs to be executed
jobs:
    validate-deployment-on-integration-org:
        runs-on: ubuntu-latest
        if: ${{ github.actor != 'dependabot[bot]' }}
        steps:
            # Install nodejs
            - uses: actions/setup-node@v2
              with:
                node-version: '14'

            # Checkout the source code
            - name: 'Checkout source code'
              uses: actions/checkout@v2
              with:
                fetch-depth: 0

            # Install Salesforce CLI
            - name: 'Install Salesforce CLI'
              run: |
                  wget https://developer.salesforce.com/media/salesforce-cli/sfdx/channels/stable/sfdx-linux-x64.tar.xz
                  mkdir ~/sfdx
                  tar xJf sfdx-linux-x64.tar.xz -C ~/sfdx --strip-components 1
                  echo "$HOME/sfdx/bin" >> $GITHUB_PATH
                  ~/sfdx/bin/sfdx version

            # # Authenticate to org using the URL stored in the text file
            - name: 'Authenticate to Dev Org'
              run: sfdx auth:jwt:grant --instanceurl "https://login.salesforce.com" --clientid "3MVG9Ud3b0C7KnnhdTRgFNnT63aq5gW_bBcLefB7ckqfdvHBBH9zTcG5Z_q68PkahQhIfJWJobtKIpmB3j0xX" --username "saikiran.salla@cunning-fox-8pcpg0.com" --jwtkeyfile key/server.key --setalias DEV

            # Get latest metadata from Prod
            - name: 'Pull latest metadata from Prod'
              run: |
                  git checkout main
                  sfdx force:source:retrieve -x ./manifest/package.xml -u DEV
                  echo "SS"
                  git status
                  git commit -am "Updates from Production"
                  git push
